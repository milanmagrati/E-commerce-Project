{% extends 'base.html' %}
{% load dashboard_extras %}
{% block title %}Edit Order #{{ order.order_number }} - POS{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #667eea;
        --primary-dark: #5568d3;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
    }

    body {
        background: #f8fafc;
    }

    .pos-wrapper {
        max-width: 1600px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .pos-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        animation: slideIn 0.4s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .pos-header {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        color: white;
        padding: 1.25rem 1.5rem;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .pos-header h4 {
        margin: 0;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .pos-body {
        padding: 1.5rem;
    }

    .form-control,
    .form-select {
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        height: 38px;
        background: white;
        transition: all 0.3s ease;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        outline: none;
        transform: translateY(-1px);
    }

    textarea.form-control {
        resize: none;
        min-height: 38px;
    }

    .form-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 0.25rem;
        text-transform: uppercase;
        letter-spacing: 0.025em;
        display: block;
    }

    .table-wrapper {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        background: #fafbfc;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    .table-scroll {
        max-height: 300px;
        overflow-y: auto;
    }

    .table-scroll::-webkit-scrollbar {
        width: 8px;
    }

    .table-scroll::-webkit-scrollbar-track {
        background: #f1f5f9;
    }

    .table-scroll::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 4px;
    }

    .product-table {
        width: 100%;
        margin: 0;
    }

    .product-table thead {
        background: var(--primary);
        color: white;
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .product-table thead th {
        padding: 0.75rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        border: none;
        white-space: nowrap;
    }

    .product-table tbody td {
        padding: 0.75rem 0.5rem;
        font-size: 0.875rem;
        border-bottom: 1px solid #e2e8f0;
        vertical-align: middle;
    }

    .product-table tbody tr {
        animation: slideInRow 0.3s ease-out;
    }

    @keyframes slideInRow {
        from {
            opacity: 0;
            transform: translateX(-10px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .product-table tbody tr:hover {
        background: #f8fafc;
        transform: scale(1.005);
        transition: all 0.2s ease;
    }

    .empty-cart {
        text-align: center;
        padding: 3rem 1rem;
        color: #94a3b8;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% {
            opacity: 0.6;
        }
        50% {
            opacity: 1;
        }
    }

    .empty-cart i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.4;
    }

    .qty-control {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .qty-control .btn {
        width: 30px;
        height: 30px;
        padding: 0;
        font-size: 0.75rem;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .qty-control .btn:hover {
        transform: scale(1.15);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    }

    .qty-control .btn:active {
        transform: scale(0.95);
    }

    .qty-control input {
        width: 50px;
        text-align: center;
        height: 30px;
        font-size: 0.875rem;
        border: 1px solid #e2e8f0;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .qty-control input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-add-product {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        border: none;
        color: white;
        padding: 0 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.875rem;
        height: 38px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(16, 185, 129, 0.25);
    }

    .btn-add-product::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.6s, height 0.6s;
    }

    .btn-add-product:hover::before {
        width: 300px;
        height: 300px;
    }

    .btn-add-product:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
    }

    .btn-add-product:active {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
    }

    .btn-add-product i {
        transition: transform 0.3s ease;
    }

    .btn-add-product:hover i {
        transform: rotate(90deg) scale(1.1);
    }

    .btn-update {
        background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
        border: none;
        color: white;
        padding: 0.75rem 3rem;
        border-radius: 8px;
        font-weight: 700;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
    }

    .btn-update::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s;
    }

    .btn-update:hover::before {
        left: 100%;
    }

    .btn-update:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
    }

    .btn-update:active {
        transform: translateY(-1px);
    }

    .btn-update:disabled {
        background: #94a3b8;
        cursor: not-allowed;
        transform: none;
        animation: none;
        box-shadow: none;
    }

    .total-box {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        margin-top: 1rem;
        animation: fadeInUp 0.5s ease-out;
        box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        transition: all 0.3s ease;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .total-box:hover {
        box-shadow: 0 8px 30px rgba(102, 126, 234, 0.4);
        transform: translateY(-2px);
    }

    .total-box .total-amount {
        font-size: 2.5rem;
        font-weight: 800;
        line-height: 1;
        animation: countUp 0.5s ease-out;
    }

    @keyframes countUp {
        from {
            opacity: 0;
            transform: scale(0.5);
        }
        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
        opacity: 0;
        animation: fadeInLeft 0.5s ease-out forwards;
    }

    .total-row:nth-child(1) {
        animation-delay: 0.1s;
    }

    .total-row:nth-child(2) {
        animation-delay: 0.2s;
    }

    .total-row:nth-child(3) {
        animation-delay: 0.3s;
    }

    .total-row:nth-child(4) {
        animation-delay: 0.4s;
    }

    @keyframes fadeInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .recent-section {
        margin-top: 2rem;
        padding-top: 2rem;
        border-top: 2px solid #e2e8f0;
    }

    .order-card {
        background: white;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        height: 100%;
        animation: slideInUp 0.4s ease-out;
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .order-card:hover {
        border-color: var(--primary);
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }

    .order-number {
        font-weight: 700;
        color: var(--primary);
        font-size: 0.95rem;
        margin-bottom: 0.5rem;
        transition: color 0.3s ease;
    }

    .order-card:hover .order-number {
        color: var(--primary-dark);
    }

    .product-card {
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
    }

    .product-card:hover {
        border-color: var(--primary);
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .product-img {
        height: 180px;
        object-fit: cover;
        width: 100%;
        transition: transform 0.5s ease;
    }

    .product-card:hover .product-img {
        transform: scale(1.1) rotate(2deg);
    }

    .product-card-body {
        padding: 0.75rem;
        background: white;
        transition: background 0.3s ease;
    }

    .product-card:hover .product-card-body {
        background: #f8fafc;
    }

    .badge {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    .section-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent, #e2e8f0, transparent);
        margin: 1.5rem 0;
    }

    .btn-danger {
        transition: all 0.3s ease;
    }

    .btn-danger:hover {
        transform: rotate(15deg) scale(1.1);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }

    .btn-danger:active {
        transform: rotate(0) scale(0.95);
    }

    @keyframes fadeOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(-50px);
        }
    }

    .deleting {
        animation: fadeOut 0.3s ease-out forwards;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .fa-spinner {
        animation: spin 1s linear infinite;
    }

    .btn-light {
        transition: all 0.3s ease;
    }

    .btn-light:hover {
        transform: translateX(-5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .alert-success {
        animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .valley-info-box {
        margin-top: 5px;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid transparent;
    }

    .valley-info-box.valley {
        background: #d1fae5;
        border-left-color: #10b981;
        color: #065f46;
    }

    .valley-info-box.out-valley {
        background: #fef3c7;
        border-left-color: #f59e0b;
        color: #92400e;
    }

    .valley-info-box.unknown {
        background: #e5e7eb;
        border-left-color: #6b7280;
        color: #374151;
    }

    .valley-info-box.error {
        background: #fee2e2;
        border-left-color: #ef4444;
        color: #991b1b;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    #partialPaymentModal .modal-content {
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    #partialPaymentModal .modal-header {
        background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
        color: white;
        border-radius: 12px 12px 0 0;
    }

    #partialPaymentModal .btn-close {
        filter: brightness(0) invert(1);
    }

    .payment-info-box {
        background: #f0f9ff;
        border-left: 4px solid var(--info);
        padding: 0.75rem;
        border-radius: 4px;
        margin-top: 0.5rem;
        font-size: 0.875rem;
        animation: slideInRight 0.3s ease-out;
    }

    /* âœ… FLOATING CLEAR DRAFT BUTTON */
    .floating-clear-btn {
        position: fixed;
        top: 80px;
        right: 30px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        border: none;
        color: white;
        font-size: 1.5rem;
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
        cursor: pointer;
        z-index: 1000;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        animation: slideInFromRight 0.5s ease-out, float 3s ease-in-out infinite;
    }

    @keyframes slideInFromRight {
        from {
            opacity: 0;
            transform: translateX(100px) scale(0);
        }
        to {
            opacity: 1;
            transform: translateX(0) scale(1);
        }
    }

    @keyframes float {
        0%, 100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-10px);
        }
    }

    .floating-clear-btn:hover {
        transform: translateY(-5px) scale(1.1);
        box-shadow: 0 8px 30px rgba(245, 158, 11, 0.6);
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    }

    .floating-clear-btn:active {
        transform: translateY(-2px) scale(1.05);
    }

    .floating-clear-btn .draft-badge {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #ef4444;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.65rem;
        font-weight: 700;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(239, 68, 68, 0.4);
        animation: pulse-badge 2s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes pulse-badge {
        0%, 100% {
            transform: scale(1);
            opacity: 1;
        }
        50% {
            transform: scale(1.1);
            opacity: 0.9;
        }
    }

    .floating-clear-btn::before {
        content: 'Clear Draft';
        position: absolute;
        right: 70px;
        background: #1f2937;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        white-space: nowrap;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .floating-clear-btn::after {
        content: '';
        position: absolute;
        right: 60px;
        border: 6px solid transparent;
        border-left-color: #1f2937;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .floating-clear-btn:hover::before,
    .floating-clear-btn:hover::after {
        opacity: 1;
    }

    /* âœ¨ CLEAN VARIATION MODAL STYLES */
    .variation-header {
        text-align: center;
    }

    .variation-list {
        max-height: 450px;
        overflow-y: auto;
        padding-right: 0.5rem;
    }

    .variation-list::-webkit-scrollbar {
        width: 6px;
    }

    .variation-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }

    .variation-list::-webkit-scrollbar-thumb {
        background: var(--primary);
        border-radius: 3px;
    }

    .variation-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        background: white;
    }

    .variation-item:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        transform: translateX(4px);
    }

    .variation-item.selected {
        border-color: var(--primary);
        background: linear-gradient(to right, #f0f4ff, white);
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25);
    }

    .variation-check-icon {
        position: absolute;
        top: 8px;
        right: 8px;
        width: 24px;
        height: 24px;
        background: var(--success);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 0.75rem;
        opacity: 0;
        transform: scale(0);
        transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .variation-item.selected .variation-check-icon {
        opacity: 1;
        transform: scale(1);
    }

    .variation-image-box {
        flex-shrink: 0;
    }

    .variation-image-box img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 2px solid #e2e8f0;
        transition: all 0.3s ease;
    }

    .variation-item:hover .variation-image-box img {
        border-color: var(--primary);
        transform: scale(1.05);
    }

    .variation-info {
        flex: 1;
    }

    .variation-name {
        font-size: 1rem;
        line-height: 1.3;
    }

    .variation-sku {
        font-size: 0.875rem;
    }

    .variation-price {
        font-size: 1.1rem;
    }

    .variation-stock .badge {
        font-size: 0.75rem;
        padding: 0.35rem 0.75rem;
    }

    .variation-footer {
        background: #f8f9fa;
        margin: 0 -1rem -1rem;
        padding: 1rem;
        border-radius: 0 0 8px 8px;
    }

    /* âœ¨ CUSTOM PRODUCT MODAL STYLES */
    #customProductModal .modal-header {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #1f2937;
        border-bottom: 3px solid #d97706;
    }

    #customProductModal .form-control:focus,
    #customProductModal .form-select:focus {
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.1);
    }

    .btn-warning.btn-sm {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        border: none;
        color: #1f2937;
        font-weight: 600;
        transition: all 0.3s ease;
        padding: 0.375rem 0.75rem;
    }

    .btn-warning.btn-sm:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
    }

    .custom-product-badge {
        background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
        color: #1f2937;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 700;
        text-transform: uppercase;
        margin-left: 0.5rem;
    }

    /* Mobile responsive */
    @media (max-width: 768px) {
        .floating-clear-btn {
            width: 50px;
            height: 50px;
            font-size: 1.2rem;
            top: 70px;
            right: 15px;
        }
        
        .draft-badge {
            font-size: 0.6rem;
            padding: 3px 6px;
        }

        .variation-item {
            flex-direction: column;
            text-align: center;
        }
        
        .variation-image-box {
            margin: 0 auto;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="pos-wrapper">
    <div class="pos-card">
        <div class="pos-header">
            <h4>
                <i class="fas fa-edit"></i>
                Edit Order #{{ order.order_number }}
            </h4>
            <div class="d-flex gap-2">
                <a href="{% url 'city_management' %}" class="btn btn-info btn-sm">
                    <i class="fas fa-city"></i> Manage Cities
                </a>
                <a href="{% url 'orders_list' %}" class="btn btn-light btn-sm">
                    <i class="fas fa-arrow-left"></i> Back
                </a>
            </div>
        </div>

        <div class="pos-body">
            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            <form method="post" id="orderForm">
                {% csrf_token %}

                <!-- Row 1 -->
                <div class="row g-3 mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Search Phone</label>
                        <input type="text" class="form-control" id="phoneSearch" placeholder="Phone number" value="{{ order.customer_phone }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Name *</label>
                        <input type="text" name="customer_name" id="customerName" class="form-control"
                            placeholder="Name" value="{{ order.customer_name }}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Email</label>
                        <input type="email" name="customer_email" id="customerEmailInput" class="form-control"
                            placeholder="email@example.com" value="{{ order.customer_email }}">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Branch/City *</label>
                        <select name="branch_city" id="branchCity" class="form-select" required>
                            <option value="">Select Branch/City</option>
                            {% for city in cities %}
                            <option value="{{ city.name }}" {% if city.name == order.branch_city %}selected{% endif %}>{{ city.name }}</option>
                            {% empty %}
                            <option value="">No cities found. Add cities first.</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Cities from City Management</small>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Address *</label>
                        <input type="text" name="shipping_address" id="customerAddress" class="form-control"
                            placeholder="Address" value="{{ order.shipping_address }}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Landmark</label>
                        <input type="text" name="landmark" id="customerLandmark" class="form-control"
                            placeholder="Landmark" value="{{ order.landmark }}">
                    </div>
                </div>

                <!-- Row 2 -->
                <div class="row g-3 mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Created By *</label>
                        <select name="created_by" id="createdBy" class="form-select" required>
                            <option value="">Select User</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if user.id == order.created_by.id %}selected{% endif %}>
                                {{ user.get_full_name|default:user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Discount</label>
                        <input type="number" id="discount" name="discount" class="form-control" placeholder="0"
                            value="{{ order.discount|floatformat:2 }}" step="0.01">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Shipping</label>
                        <input type="number" id="shipping" name="shipping_charge" class="form-control" placeholder="0"
                            value="{{ order.shipping_charge|floatformat:2 }}" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Order Note</label>
                        <textarea name="notes" id="orderNotes" class="form-control" placeholder="Note...">{{ order.notes }}</textarea>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Status</label>
                        <select name="order_status" class="form-select">
                            <option value="processing" {% if order.order_status == 'processing' %}selected{% endif %}>Processing</option>
                            <option value="confirmed" {% if order.order_status == 'confirmed' %}selected{% endif %}>Confirmed</option>
                            <option value="shipped" {% if order.order_status == 'shipped' %}selected{% endif %}>Shipped</option>
                            <option value="delivered" {% if order.order_status == 'delivered' %}selected{% endif %}>Delivered</option>
                            <option value="cancelled" {% if order.order_status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>
                </div>

                <!-- Row 3 -->
                <div class="row g-3 mb-3">
                    <div class="col-md-2">
                        <label class="form-label">Phone *</label>
                        <input type="text" name="customer_phone" id="customerPhone" class="form-control"
                            placeholder="Phone" value="{{ order.customer_phone }}" required>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Order From *</label>
                        <select name="order_from" class="form-select" required>
                            <option value="">Select Source</option>
                            <option value="website" {% if order.order_from == 'website' %}selected{% endif %}>Website</option>
                            <option value="facebook" {% if order.order_from == 'facebook' %}selected{% endif %}>Facebook</option>
                            <option value="instagram" {% if order.order_from == 'instagram' %}selected{% endif %}>Instagram</option>
                            <option value="phone" {% if order.order_from == 'phone' %}selected{% endif %}>Phone</option>
                            <option value="walk-in" {% if order.order_from == 'walk-in' %}selected{% endif %}>Walk-in</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Payment</label>
                        <select name="payment_method" id="paymentMethod" class="form-select">
                            <option value="cod" {% if order.payment_method == 'cod' %}selected{% endif %}>Cash on Delivery</option>
                            <option value="esewa" {% if order.payment_method == 'esewa' %}selected{% endif %}>eSewa</option>
                            <option value="khalti" {% if order.payment_method == 'khalti' %}selected{% endif %}>Khalti</option>
                            <option value="bank" {% if order.payment_method == 'bank' %}selected{% endif %}>Bank Transfer</option>
                            <option value="cash" {% if order.payment_method == 'cash' %}selected{% endif %}>Cash</option>
                            <option value="partial" {% if order.payment_method == 'partial' %}selected{% endif %}>Partial Payment</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tax (%)</label>
                        <input type="number" id="taxPercent" name="tax_percent" class="form-control" placeholder="13"
                            value="{{ order.tax_percent|default:'13' }}" step="0.01" min="0">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">IN/OUT *</label>
                        <select name="in_out" id="inOutSelect" class="form-select" required>
                            <option value="in" {% if order.in_out == 'in' %}selected{% endif %}>Valley</option>
                            <option value="out" {% if order.in_out == 'out' %}selected{% endif %}>Out Valley</option>
                        </select>
                        <div id="valleyStatusInfo"></div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label d-block text-truncate">&nbsp;</label>
                        <button id="addProductsBtn" type="button" class="btn btn-add-product w-100" data-bs-toggle="modal"
                            data-bs-target="#productModal">
                            <i class="fas fa-plus-circle"></i> Add Products
                        </button>
                    </div>
                </div>

                <div class="section-divider"></div>

                <!-- Products Table -->
                <div class="table-wrapper mb-3">
                    <div class="table-scroll">
                        <table class="product-table">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th width="150">Variant</th>
                                    <th width="140">Quantity</th>
                                    <th width="100">Price</th>
                                    <th width="60"></th>
                                </tr>
                            </thead>
                            <tbody id="cartBody">
                                <tr id="emptyRow">
                                    <td colspan="5">
                                        <div class="empty-cart">
                                            <i class="fas fa-shopping-cart"></i>
                                            <p class="mb-0">No products added</p>
                                            <small>Click "Add Products" to start</small>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Total Box -->
                <div class="total-box">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <div class="total-row">
                                <span>Subtotal:</span>
                                <strong id="subtotal">à¤°à¥‚ 0.00</strong>
                            </div>
                            <div class="total-row">
                                <span>Discount:</span>
                                <strong id="discountAmount">- à¤°à¥‚ 0.00</strong>
                            </div>
                            <div class="total-row">
                                <span>Shipping:</span>
                                <strong id="shippingAmount">+ à¤°à¥‚ 0.00</strong>
                            </div>
                            <div class="total-row">
                                <span>Tax (<span id="taxPercentDisplay">13</span>%):</span>
                                <strong id="taxAmount">+ à¤°à¥‚ 0.00</strong>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <small class="d-block mb-2">TOTAL AMOUNT</small>
                            <div class="total-amount" id="totalAmount">à¤°à¥‚ 0.00</div>
                        </div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-update" id="submitBtn">
                        <i class="fas fa-save"></i> Update Order
                    </button>
                </div>

                <!-- Hidden Inputs -->
                <input type="hidden" name="order_items" id="orderItems">
                <input type="hidden" name="total_amount" id="totalInput">
                <input type="hidden" name="payment_status" value="{{ order.payment_status }}">
                <input type="hidden" name="partial_amount_paid" id="partialAmountPaidHidden" value="{{ order.partial_amount_paid|floatformat:2 }}">
                <input type="hidden" name="remaining_amount" id="remainingAmountHidden" value="{{ order.remaining_amount|floatformat:2 }}">
                <input type="hidden" name="is_partial_payment" id="isPartialPayment" value="{{ order.is_partial_payment|yesno:'true,false' }}">
            </form>

            <!-- Recent Orders -->
            <div class="recent-section">
                <h5 class="mb-3"><i class="fas fa-history"></i> Recent Orders</h5>
                <div class="row g-2" id="recentOrdersContainer">
                    {% for recent_order in recent_orders|slice:":6" %}
                    <div class="col-md-2">
                        <a href="{% url 'order_detail' recent_order.id %}" class="text-decoration-none">
                            <div class="order-card">
                                <div class="order-number">
                                    <i class="fas fa-receipt"></i> #{{ recent_order.order_number|slice:"-4:" }}
                                </div>
                                <p class="mb-1 small fw-bold text-dark">{{ recent_order.customer_name }}</p>
                                <p class="mb-1 small text-muted">{{ recent_order.created_by.username }}</p>
                                <p class="mb-0 small text-muted">{{ recent_order.created_at|date:"M d, H:i" }}</p>
                            </div>
                        </a>
                    </div>
                    {% empty %}
                    <div class="col-12 text-center text-muted py-3">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>No recent orders</p>
                    </div>
                    {% endfor %}
                </div>
            </div>

        </div>
    </div>
    
    <!-- âœ… FLOATING CLEAR DRAFT BUTTON -->
    <button type="button" class="floating-clear-btn" id="floatingClearBtn" onclick="clearDraftConfirm()" style="display: none;">
        <i class="fas fa-eraser"></i>
        <span class="draft-badge" id="draftBadge">Draft</span>
    </button>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center;">
                <h5 class="modal-title"><i class="fas fa-box"></i> Select Products</h5>
                <div class="d-flex gap-2 align-items-center">
                    <!-- âœ¨ NEW: Add Custom Product Button -->
                    <button type="button" class="btn btn-warning btn-sm" onclick="openCustomProductModal()">
                        <i class="fas fa-bolt"></i> Add Custom Product
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
            </div>
            <div class="modal-body">
                <input type="text" id="searchProduct" class="form-control mb-3" placeholder="ðŸ” Search products...">
                <div id="productGrid" class="row g-3" style="min-height: 200px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- âœ¨ VARIATION MODAL - CLEAN & PROFESSIONAL -->
<div class="modal fade" id="variationModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-layer-group"></i> Select Variation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="variationBody"></div>
        </div>
    </div>
</div>

<!-- Partial Payment Modal -->
<div class="modal fade" id="partialPaymentModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-money-bill-wave"></i> Partial Payment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Total Order Amount</label>
                    <input type="text" class="form-control" id="totalOrderAmount" readonly
                        style="background: #f8fafc; font-weight: 600; font-size: 1.1rem; color: var(--primary);">
                </div>
                <div class="mb-3">
                    <label class="form-label">Amount Paid <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="partialAmountPaid" placeholder="Enter paid amount"
                        step="0.01" min="0" value="{{ order.partial_amount_paid|floatformat:2 }}">
                    <small class="text-muted">Enter the amount customer has already paid</small>
                </div>
                <div class="mb-3">
                    <label class="form-label">Remaining Amount</label>
                    <input type="text" class="form-control" id="remainingAmount" readonly
                        style="background: #fef3c7; font-weight: 600; font-size: 1.1rem; color: #f59e0b;">
                </div>
                <div class="alert alert-info mb-0" style="font-size: 0.875rem;">
                    <i class="fas fa-info-circle"></i> The remaining amount will be collected later from the customer.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmPartialPayment()">
                    <i class="fas fa-check"></i> Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<!-- âœ¨ CUSTOM PRODUCT MODAL -->
<div class="modal fade" id="customProductModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-bolt"></i> Add Custom Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="customProductForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="customProductName" placeholder="Enter product name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">SKU</label>
                            <input type="text" class="form-control" id="customProductSKU" placeholder="Auto-generated" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Price *</label>
                            <input type="number" class="form-control" id="customProductPrice" placeholder="0.00" step="0.01" min="0" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Quantity *</label>
                            <input type="number" class="form-control" id="customProductQty" placeholder="1" min="1" value="1" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="customProductCategory">
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category.id }}">{{ category.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Image (Optional)</label>
                            <input type="file" class="form-control" id="customProductImage" accept="image/*">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="customProductDescription" rows="3" placeholder="Product description..."></textarea>
                        </div>
                        <div class="col-12" id="customImagePreviewContainer" style="display: none;">
                            <img id="customImagePreview" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border-radius: 8px; border: 2px solid #e2e8f0;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="addCustomProductToCart()">
                    <i class="fas fa-plus-circle"></i> Add to Order
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let cart = [];
    let productModal, variationModal, partialPaymentModal, customProductModal;
    let phoneSearchTimer;
    let isPartialPaymentSelected = {{ order.is_partial_payment|yesno:'true,false' }};
    let customProductImageFile = null;
    const ORDER_ID = '{{ order.id }}';
    const STORAGE_KEY = `order_edit_draft_${ORDER_ID}`;
    // Session-only backup (persists across navigations in same tab) to survive other pages clearing localStorage
    const SESSION_KEY = `order_edit_draft_${ORDER_ID}_session`; 

    // âœ… TOAST NOTIFICATION
    function showToastNotification(message, type = 'info') {
        const colors = {
            success: '#10b981',
            error: '#ef4444',
            warning: '#f59e0b',
            info: '#3b82f6'
        };

        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type] || colors.info};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out, fadeOut 0.3s ease-out 2.7s;
            max-width: 400px;
            font-weight: 600;
        `;
        toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
        document.body.appendChild(toast);

        setTimeout(() => toast.remove(), 3000);
    }

    // âœ… LOAD PRODUCTS
    function loadProducts(searchQuery = '') {
        const grid = document.getElementById('productGrid');
        grid.innerHTML = '<div class="col-12 text-center"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Loading products...</p></div>';

        fetch(`/api/search-products/?q=${encodeURIComponent(searchQuery)}`)
            .then(res => res.json())
            .then(data => {
                const products = data.products || [];
                if (products.length === 0) {
                    grid.innerHTML = '<div class="col-12 text-center text-muted"><i class="fas fa-box-open fa-3x mb-3"></i><p>No products found</p></div>';
                    return;
                }

                grid.innerHTML = products.map(p => `
                    <div class="col-md-3 col-sm-6">
                        <div class="product-card" data-id="${p.id}" data-name="${encodeURIComponent(p.name)}" data-has-variations="${p.product_type === 'variable'}">
                            <img src="${p.image || 'https://via.placeholder.com/150?text=No+Image'}" class="product-img" alt="${p.name}">
                            <div class="product-card-body">
                                <h6 class="mb-1" style="font-size: 0.9rem; font-weight: 700; color: #1e293b;">${p.name}</h6>
                                <p class="mb-1"><span class="badge bg-success">à¤°à¥‚ ${parseFloat(p.price).toFixed(2)}</span></p>
                                <p class="mb-0 small text-muted">
                                    ${p.stock > 0 ? `<span class="badge bg-success">In Stock: ${p.stock}</span>` : '<span class="badge bg-danger">Out of Stock</span>'}
                                    ${p.product_type === 'variable' ? '<span class="badge bg-info ms-1">Has Variations</span>' : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Attach click handlers safely (avoid inline JS escaping issues)
                setTimeout(() => {
                    const cards = grid.querySelectorAll('.product-card');
                    cards.forEach(card => {
                        card.style.cursor = 'pointer';
                        card.addEventListener('click', function() {
                            try {
                                const pid = Number(this.dataset.id);
                                const pname = decodeURIComponent(this.dataset.name || '');
                                const hasVariations = String(this.dataset.hasVariations) === 'true' || this.dataset.hasVariations === 'true' || this.dataset.hasVariations === 'True';
                                selectProduct(pid, pname, hasVariations);
                            } catch (err) {
                                console.error('Error handling product card click', err, this.dataset);
                                showToastNotification('Error selecting product. Check console for details.', 'error');
                            }
                        });
                    });
                }, 10);
            })
            .catch(err => {
                console.error('Error loading products:', err);
                grid.innerHTML = '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Failed to load products</p></div>';
            });
    }

    // âœ… SELECT PRODUCT
    function selectProduct(productId, productName, hasVariations) {
        try {
            console.log('selectProduct called', { productId, productName, hasVariations });

            if (hasVariations) {
                loadVariations(productId, productName);
                return;
            }

            fetch(`/api/product/${productId}/`)
                .then(res => {
                    if (!res.ok) throw new Error('Failed to fetch product');
                    return res.json();
                })
.then(data => {
                    try {
                        if (!data || !data.success || !data.product) {
                            throw new Error((data && data.message) || 'Invalid product data');
                        }

                        const product = data.product;

                        addToCart({
                            id: product.id,
                            varId: null,
                            name: product.name,
                            sku: product.sku || '',
                            price: parseFloat(product.price) || 0,
                            qty: 1,
                            isCustom: product.is_custom || false,
                            category: product.category && product.category.id ? product.category.id : null,
                            categoryName: product.category && product.category.name ? product.category.name : '',
                            description: product.description || ''
                        });
                        productModal.hide();
                        showToastNotification(`âœ… ${product.name} added to cart!`, 'success');
                        saveFormData();

                    } catch (err) {
                        console.error('Error adding product to cart', err, data);
                        showToastNotification('Error adding product to cart', 'error');
                    }
                })
                .catch(err => {
                    console.error('Error selecting product:', err);
                    showToastNotification('Failed to load product details', 'error');
                });
        } catch (err) {
            console.error('selectProduct unexpected error', err);
            showToastNotification('Unexpected error. See console for details.', 'error');
        }
    }

    // âœ… LOAD VARIATIONS
    function loadVariations(productId, productName) {
        const variationBody = document.getElementById('variationBody');
        variationBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Loading variations...</p></div>';

        fetch(`/api/product/${productId}/variations/`)
            .then(res => { if (!res.ok) throw new Error('Network response not ok'); return res.json(); })
            .then(data => {
                const variations = data && Array.isArray(data.variations) ? data.variations : (Array.isArray(data) ? data : []);

                if (!variations || variations.length === 0) {
                    variationBody.innerHTML = '<div class="text-center text-muted"><i class="fas fa-box-open fa-3x mb-3"></i><p>No variations available</p></div>';
                    return;
                }

                variationBody.innerHTML = `
                    <div class="variation-header mb-3">
                        <h6 class="mb-1"><strong>${productName}</strong></h6>
                        <p class="text-muted small mb-0">Select a variation to add to cart</p>
                    </div>
                    <div class="variation-list">
                        ${variations.map(v => `
                            <div class="variation-item" tabindex="0" data-varid="${v.id}" data-sku="${v.sku}" data-varname="${(v.variation_name || v.name || v.sku || '').replace(/"/g, '&quot;')}" data-price="${v.price}" data-category-id="${v.category ? v.category.id : ''}" data-category-name="${v.category ? (v.category.name || '').replace(/"/g, '&quot;') : ''}">
                                <div class="variation-check-icon">
                                    <i class="fas fa-check"></i>
                                </div>
                                <div class="variation-image-box">
                                    <img src="${v.image || 'https://via.placeholder.com/150?text=No+Image'}" alt="${v.sku}">
                                </div>
                                <div class="variation-info">
                                    <div class="variation-name">
                                        <strong>${v.variation_name || v.sku || ''}</strong>
                                    </div>
                                    <div class="variation-sku text-muted small">
                                        SKU: ${v.sku}
                                    </div>
                                    <div class="variation-price text-success mt-1">
                                        <strong>à¤°à¥‚ ${parseFloat(v.price).toFixed(2)}</strong>
                                    </div>
                                    <div class="variation-stock mt-1">
                                        ${v.stock > 0 ? `<span class="badge bg-success">Stock: ${v.stock}</span>` : '<span class="badge bg-danger">Out of Stock</span>'}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="variation-footer d-flex gap-2">
                        <button type="button" class="btn btn-secondary" onclick="variationModal.hide()">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-success" id="addVariationToCartBtn">
                            <i class="fas fa-shopping-cart"></i> Add to Cart
                        </button>
                    </div>
                `;

                // Setup selection handling
                setTimeout(() => {
                    const items = document.querySelectorAll('.variation-item');
                    let selectedVar = null;

                    function selectVarNode(el) {
                        items.forEach(i => i.classList.remove('selected'));
                        el.classList.add('selected');
                        selectedVar = {
                            id: Number(el.dataset.varid),
                            sku: el.dataset.sku,
                            varName: el.dataset.varname || el.dataset.sku || '',
                            price: parseFloat(el.dataset.price),
                            categoryId: el.dataset.categoryId || '',
                            categoryName: el.dataset.categoryName || ''
                        };
                    }

                    items.forEach(el => {
                        el.addEventListener('click', () => selectVarNode(el));
                        el.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') selectVarNode(el); });
                    });

                    const addBtn = document.getElementById('addVariationToCartBtn');
                    if (addBtn) {
                        addBtn.addEventListener('click', () => {
                            if (!selectedVar) { alert('Please select a variation'); return; }
                            // Pass variation display name (varName) instead of SKU so variant shows the variation name
                            selectVariation(productId, selectedVar.id, productName, selectedVar.varName, selectedVar.price, selectedVar.categoryId, selectedVar.categoryName);
                        });
                    }
                }, 10);


                productModal.hide();
                setTimeout(() => variationModal.show(), 300);
            })
            .catch(err => {
                console.error('Error loading variations:', err);
                variationBody.innerHTML = '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>Failed to load variations</p></div>';
                showToastNotification('Failed to load variations', 'error');
            });
    }

    // âœ… SELECT VARIATION (store variation name as SKU/variant display)
    function selectVariation(productId, variationId, productName, variantName, price, categoryId, categoryName) {
        // Use variantName as the displayed 'sku' so the cart shows the variation name
        addToCart({
            id: productId,
            varId: variationId,
            name: productName,
            sku: variantName || '',
            price: parseFloat(price),
            qty: 1,
            isCustom: false,
            category: categoryId || null,
            categoryName: categoryName || ''
        });
        variationModal.hide();
        showToastNotification(`âœ… ${productName} (${variantName}) added to cart!`, 'success');
        saveFormData();
    }

    // âœ… ADD TO CART
    function addToCart(product) {
        const existingIndex = cart.findIndex(item => 
            item.id === product.id && item.varId === product.varId
        );

        if (existingIndex !== -1) {
            cart[existingIndex].qty++;
        } else {
            cart.push(product);
        }

        updateCart();
        updateTotal();
        saveFormData();
        showFloatingButton();
    }

    // âœ… UPDATE CART
    function updateCart() {
        const tbody = document.getElementById('cartBody');
        const emptyRow = document.getElementById('emptyRow');

        if (cart.length === 0) {
            if (emptyRow) emptyRow.style.display = 'table-row';
            return;
        }

        if (emptyRow) emptyRow.style.display = 'none';

        tbody.innerHTML = cart.map((item, index) => `
            <tr id="row-${index}">
                <td>
                    <strong>${item.name}</strong>
                    ${item.isCustom ? '<span class="custom-product-badge">Custom</span>' : ''}
                    <br><small class="text-muted">à¤°à¥‚ ${item.price.toFixed(2)} each</small>
                </td>
                <td>
                    ${item.varId ? (item.sku ? `<span class="badge bg-secondary">${item.sku}</span>` : '-') : '-'}
                </td>
                <td>
                    <div class="qty-control">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="changeQty(${index}, -1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <input type="number" value="${item.qty}" onchange="setQty(${index}, this.value)" min="1">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="changeQty(${index}, 1)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </td>
                <td><strong class="text-success">à¤°à¥‚ ${(item.price * item.qty).toFixed(2)}</strong></td>
                <td>
                    <button type="button" class="btn btn-sm btn-danger" onclick="removeItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');

        document.getElementById('submitBtn').disabled = cart.length === 0;
    }

    // âœ… CHANGE QUANTITY
    function changeQty(index, delta) {
        if (cart[index]) {
            cart[index].qty = Math.max(1, cart[index].qty + delta);
            updateCart();
            updateTotal();
            saveFormData();
        }
    }

    // âœ… SET QUANTITY
    function setQty(index, value) {
        const qty = parseInt(value);
        if (qty > 0 && cart[index]) {
            cart[index].qty = qty;
            updateCart();
            updateTotal();
            saveFormData();
        }
    }

    // âœ… REMOVE ITEM
    function removeItem(index) {
        if (confirm('Remove this product from the cart?')) {
            cart.splice(index, 1);
            updateCart();
            updateTotal();
            saveFormData();
            showToastNotification('Product removed from cart', 'info');
            
            if (cart.length === 0) {
                hideFloatingButton();
            }
        }
    }

    // âœ… UPDATE TOTAL
    function updateTotal() {
        const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
        const discount = parseFloat(document.getElementById('discount').value) || 0;
        const shipping = parseFloat(document.getElementById('shipping').value) || 0;
        const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;

        const afterDiscount = subtotal - discount;
        const taxAmount = (afterDiscount + shipping) * (taxPercent / 100);
        const total = afterDiscount + shipping + taxAmount;

        document.getElementById('subtotal').textContent = `à¤°à¥‚ ${subtotal.toFixed(2)}`;
        document.getElementById('discountAmount').textContent = `- à¤°à¥‚ ${discount.toFixed(2)}`;
        document.getElementById('shippingAmount').textContent = `+ à¤°à¥‚ ${shipping.toFixed(2)}`;
        document.getElementById('taxAmount').textContent = `+ à¤°à¥‚ ${taxAmount.toFixed(2)}`;
        document.getElementById('taxPercentDisplay').textContent = taxPercent.toFixed(2);
        document.getElementById('totalAmount').textContent = `à¤°à¥‚ ${total.toFixed(2)}`;

        document.getElementById('totalInput').value = total.toFixed(2);
        document.getElementById('orderItems').value = JSON.stringify(cart);
    }

    // âœ… DETECT VALLEY STATUS FROM CITY (robust version - same UX as Order Create)
    let currentCityDetectionInProgress = false;

    function detectValleyStatusFromCity() {
        const citySelect = document.getElementById('branchCity');
        const cityName = citySelect.value;
        const inOutSelect = document.getElementById('inOutSelect');

        if (!cityName || currentCityDetectionInProgress) return;

        currentCityDetectionInProgress = true;

        const originalValue = inOutSelect.value;
        inOutSelect.disabled = true;
        inOutSelect.innerHTML = '<option value="">Detecting valley status...</option>';

        clearValleyStatusInfo();

        const valleyEndpoints = [
            `/api/cities/get-valley-status/?city=${encodeURIComponent(cityName)}`,
            `/get_valley_status/?city=${encodeURIComponent(cityName)}`
        ];

        let attemptIndex = 0;

        function tryNextEndpoint() {
            if (attemptIndex >= valleyEndpoints.length) {
                restoreInOutOptions(inOutSelect);
                console.error('All valley detection attempts failed');
                inOutSelect.value = originalValue || 'in';
                showValleyInfo('error', cityName, 'Network or server error');
                showToastNotification('Error detecting valley status. Defaulted to Valley. Please check network.', 'error');
                inOutSelect.disabled = false;
                currentCityDetectionInProgress = false;
                saveFormData();
                return;
            }

            const url = valleyEndpoints[attemptIndex++];
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.json();
                })
                .then(data => {
                    restoreInOutOptions(inOutSelect);

                    if (data.success) {
                        if ((data.valley_status && data.valley_status === 'valley') || (data.in_out && String(data.in_out).toLowerCase() === 'in')) {
                            inOutSelect.value = 'in';
                            showValleyInfo('valley', cityName, data.display_status || 'Valley');
                        } else {
                            inOutSelect.value = 'out';
                            showValleyInfo('out_valley', cityName, data.display_status || 'Out Valley');
                        }

                        if (!data.exists && data.message) {
                            showToastNotification(data.message, (data.valley_status === 'valley' || (data.in_out && String(data.in_out).toLowerCase() === 'in')) ? 'success' : 'warning');
                        }

                        inOutSelect.disabled = false;
                        currentCityDetectionInProgress = false;
                        saveFormData();
                    } else {
                        tryNextEndpoint();
                    }
                })
                .catch(err => {
                    console.warn('Valley detection attempt failed for', url, err);
                    tryNextEndpoint();
                });
        }

        tryNextEndpoint();
    }

    function showValleyInfo(status, cityName, displayStatus) {
        const infoDiv = document.getElementById('valleyStatusInfo');

        let message = '';
        let className = '';

        switch (status) {
            case 'valley':
                message = `<i class="fas fa-mountain"></i> <strong>${cityName}</strong> is a Valley city (${displayStatus}). Auto-set to <strong>Valley</strong>`;
                className = 'valley-info-box valley';
                break;
            case 'out_valley':
                message = `<i class="fas fa-truck"></i> <strong>${cityName}</strong> is an Out Valley city (${displayStatus}). Auto-set to <strong>Out Valley</strong>`;
                className = 'valley-info-box out-valley';
                break;
            case 'unknown':
                message = `<i class="fas fa-question-circle"></i> <strong>${cityName}</strong> not found in database. Defaulting to <strong>Valley</strong>`;
                className = 'valley-info-box unknown';
                break;
            case 'error':
                message = `<i class="fas fa-exclamation-triangle"></i> Error detecting valley status for <strong>${cityName}</strong>. Defaulting to <strong>Valley</strong>`;
                className = 'valley-info-box error';
                break;
        }

        infoDiv.innerHTML = `<div class="${className}">${message}</div>`;
    }

    function clearValleyStatusInfo() {
        const infoDiv = document.getElementById('valleyStatusInfo');
        infoDiv.innerHTML = '';
    }

    function restoreInOutOptions(selectElement) {
        selectElement.innerHTML = `
        <option value="in">Valley</option>
        <option value="out">Out Valley</option>
        `;
    }

    // âœ… PARTIAL PAYMENT
    document.getElementById('paymentMethod').addEventListener('change', function() {
        if (this.value === 'partial') {
            const total = parseFloat(document.getElementById('totalInput').value) || 0;
            document.getElementById('totalOrderAmount').value = `à¤°à¥‚ ${total.toFixed(2)}`;
            
            const currentPaid = parseFloat(document.getElementById('partialAmountPaidHidden').value) || 0;
            document.getElementById('partialAmountPaid').value = currentPaid.toFixed(2);
            
            calculateRemaining();
            partialPaymentModal.show();
        } else {
            isPartialPaymentSelected = false;
            document.getElementById('isPartialPayment').value = 'false';
            document.getElementById('partialAmountPaidHidden').value = '0';
            document.getElementById('remainingAmountHidden').value = '0';
            
            const paymentLabel = this.closest('.col-md-2');
            const infoBox = paymentLabel.querySelector('.payment-info-box');
            if (infoBox) infoBox.remove();
        }
    });

    document.getElementById('partialAmountPaid').addEventListener('input', calculateRemaining);

    function calculateRemaining() {
        const total = parseFloat(document.getElementById('totalInput').value) || 0;
        const paid = parseFloat(document.getElementById('partialAmountPaid').value) || 0;
        const remaining = Math.max(0, total - paid);
        document.getElementById('remainingAmount').value = `à¤°à¥‚ ${remaining.toFixed(2)}`;
    }

    function confirmPartialPayment() {
        const total = parseFloat(document.getElementById('totalInput').value) || 0;
        const paid = parseFloat(document.getElementById('partialAmountPaid').value) || 0;

        if (paid <= 0) {
            alert('Please enter a valid amount paid.');
            return;
        }

        if (paid > total) {
            alert('Amount paid cannot exceed total amount.');
            return;
        }

        const remaining = total - paid;

        isPartialPaymentSelected = true;
        document.getElementById('isPartialPayment').value = 'true';
        document.getElementById('partialAmountPaidHidden').value = paid.toFixed(2);
        document.getElementById('remainingAmountHidden').value = remaining.toFixed(2);

        const paymentLabel = document.querySelector('select[name="payment_method"]').closest('.col-md-2');
        let infoBox = paymentLabel.querySelector('.payment-info-box');

        if (!infoBox) {
            infoBox = document.createElement('div');
            infoBox.className = 'payment-info-box';
            paymentLabel.appendChild(infoBox);
        }

        infoBox.innerHTML = `
            <small>
                <strong>Paid:</strong> à¤°à¥‚ ${paid.toFixed(2)}<br>
                <strong>Remaining:</strong> à¤°à¥‚ ${remaining.toFixed(2)}
            </small>
        `;

        partialPaymentModal.hide();
        showToastNotification('âœ… Partial payment details saved!', 'success');
        saveFormData();
    }

    // âœ… SAVE FORM DATA TO LOCAL STORAGE (with safe serialization + backup)
    function saveFormData() {
        try {
            // Serialize only plain data to avoid JSON errors (files, circular refs etc)
            const safeCart = cart.map(item => ({
                id: item.id,
                varId: item.varId === undefined ? null : item.varId,
                name: item.name || '',
                sku: item.sku || '',
                price: Number(item.price) || 0,
                qty: Number(item.qty) || 1,
                isCustom: !!item.isCustom,
                category: item.category || '',
                description: item.description || ''
            }));

            const formData = {
                cart: safeCart,
                customerName: document.getElementById('customerName').value,
                customerEmail: document.getElementById('customerEmailInput').value,
                branchCity: document.getElementById('branchCity').value,
                customerAddress: document.getElementById('customerAddress').value,
                customerLandmark: document.getElementById('customerLandmark').value,
                createdBy: document.getElementById('createdBy').value,
                discount: document.getElementById('discount').value,
                shipping: document.getElementById('shipping').value,
                orderNotes: document.getElementById('orderNotes').value,
                customerPhone: document.getElementById('customerPhone').value,
                paymentMethod: document.getElementById('paymentMethod').value,
                taxPercent: document.getElementById('taxPercent').value,
                inOut: document.getElementById('inOutSelect').value,
                orderFrom: document.querySelector('select[name="order_from"]').value,
                orderStatus: document.querySelector('select[name="order_status"]').value,
                isPartialPayment: isPartialPaymentSelected,
                partialAmountPaid: document.getElementById('partialAmountPaidHidden').value,
                remainingAmount: document.getElementById('remainingAmountHidden').value,
                timestamp: Date.now()
            };

            const payload = JSON.stringify(formData);
            // Primary + backup in localStorage
            localStorage.setItem(STORAGE_KEY, payload);
            localStorage.setItem(`${STORAGE_KEY}_backup`, payload);
            // Session backup (survives page navigation in same tab, even if localStorage is cleared elsewhere)
            try { sessionStorage.setItem(SESSION_KEY, payload); } catch(e) { /* ignore */ }

            console.log('âœ… Draft saved (primary + backup + session)', {
                primary: !!localStorage.getItem(STORAGE_KEY),
                backup: !!localStorage.getItem(`${STORAGE_KEY}_backup`),
                session: !!sessionStorage.getItem(SESSION_KEY),
                timestamp: formData.timestamp,
                cartCount: (formData.cart || []).length
            });
        } catch (err) {
            console.error('Error saving draft:', err);
        }
    }

    // âœ… LOAD FORM DATA FROM LOCAL STORAGE (with backup fallback)
    function loadFormData() {
        try {
            let stored = localStorage.getItem(STORAGE_KEY);

            // If primary key missing, check backup and restore it
            if (!stored) {
                const backup = localStorage.getItem(`${STORAGE_KEY}_backup`);
                if (backup) {
                    console.warn('Primary draft missing â€” restoring from backup');
                    try {
                        localStorage.setItem(STORAGE_KEY, backup);
                        stored = backup;
                    } catch (e) {
                        console.error('Failed to restore primary draft from backup:', e);
                        // proceed with backup in memory
                        stored = backup;
                    }
                } else {
                    // If no primary or backup, check session storage (survives same-tab navigation)
                    const sessionDraft = sessionStorage.getItem(SESSION_KEY);
                    if (sessionDraft) {
                        console.warn('Primary/backup missing â€” restoring draft from sessionStorage');
                        try {
                            // Restore into localStorage for consistency
                            localStorage.setItem(STORAGE_KEY, sessionDraft);
                            localStorage.setItem(`${STORAGE_KEY}_backup`, sessionDraft);
                        } catch(e) {
                            console.error('Failed to restore draft from sessionStorage into localStorage:', e);
                        }
                        stored = sessionDraft;
                    } else {
                        return false;
                    }
                }
            }

            const formData = JSON.parse(stored);

            // Validate timestamp
            const hoursSinceSaved = (Date.now() - formData.timestamp) / (1000 * 60 * 60);
            if (hoursSinceSaved > 24) {
                localStorage.removeItem(STORAGE_KEY);
                localStorage.removeItem(`${STORAGE_KEY}_backup`);
                return false;
            }

            document.getElementById('customerName').value = formData.customerName || '';
            document.getElementById('customerEmailInput').value = formData.customerEmail || '';
            document.getElementById('branchCity').value = formData.branchCity || '';
            document.getElementById('customerAddress').value = formData.customerAddress || '';
            document.getElementById('customerLandmark').value = formData.customerLandmark || '';
            document.getElementById('createdBy').value = formData.createdBy || '';
            document.getElementById('discount').value = formData.discount || '0';
            document.getElementById('shipping').value = formData.shipping || '0';
            document.getElementById('orderNotes').value = formData.orderNotes || '';
            document.getElementById('customerPhone').value = formData.customerPhone || '';
            document.getElementById('paymentMethod').value = formData.paymentMethod || 'cod';
            document.getElementById('taxPercent').value = formData.taxPercent || '13';
            document.getElementById('inOutSelect').value = formData.inOut || 'in';
            
            if (formData.orderFrom) {
                document.querySelector('select[name="order_from"]').value = formData.orderFrom;
            }
            if (formData.orderStatus) {
                document.querySelector('select[name="order_status"]').value = formData.orderStatus;
            }

            // Ensure cart is array
            cart = Array.isArray(formData.cart) ? formData.cart : [];
            updateCart();

            if (formData.isPartialPayment) {
                isPartialPaymentSelected = true;
                document.getElementById('isPartialPayment').value = 'true';
                document.getElementById('partialAmountPaidHidden').value = formData.partialAmountPaid;
                document.getElementById('remainingAmountHidden').value = formData.remainingAmount;

                const paymentLabel = document.querySelector('select[name="payment_method"]').closest('.col-md-2');
                let infoBox = paymentLabel.querySelector('.payment-info-box');

                if (!infoBox) {
                    infoBox = document.createElement('div');
                    infoBox.className = 'payment-info-box';
                    paymentLabel.appendChild(infoBox);
                }

                infoBox.innerHTML = `
                    <small>
                        <strong>Paid:</strong> à¤°à¥‚ ${parseFloat(formData.partialAmountPaid).toFixed(2)}<br>
                        <strong>Remaining:</strong> à¤°à¥‚ ${parseFloat(formData.remainingAmount).toFixed(2)}
                    </small>
                `;
            }

            if (formData.branchCity) {
                detectValleyStatusFromCity();
            }

            showToastNotification('Previous draft restored', 'info');
            showFloatingButton();
            return true;

        } catch (err) {
            console.error('Error loading form data:', err);
            // Do not aggressively clear backup â€” keep it for diagnostics, but remove primary to avoid broken state
            try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
            hideFloatingButton();
            return false;
        }
    }

    // âœ… CLEAR FORM DATA FROM LOCAL STORAGE (also remove backup)
    function clearFormData() {
        try { localStorage.removeItem(STORAGE_KEY); } catch(e) {}
        try { localStorage.removeItem(`${STORAGE_KEY}_backup`); } catch(e) {}
        try { sessionStorage.removeItem(SESSION_KEY); } catch(e) {}
    }

    // âœ… CLEAR DRAFT WITH CONFIRMATION
    function clearDraftConfirm() {
        if (confirm('âš ï¸ Are you sure you want to clear the draft and reset to original order data?\n\nThis will remove all unsaved changes.\n\nThis action cannot be undone.')) {
            clearDraftAndReset();
        }
    }

    // âœ… CLEAR DRAFT AND RESET FORM
    function clearDraftAndReset() {
        // Mark this session so we don't automatically restore the draft on reload
        try {
            sessionStorage.setItem('order_edit_just_cleared', '1');
        } catch(e) { /* ignore */ }
        clearFormData();
        location.reload();
    }

    // âœ… SHOW FLOATING BUTTON
    function showFloatingButton() {
        const btn = document.getElementById('floatingClearBtn');
        if (btn) btn.style.display = 'flex';
    }

    // âœ… HIDE FLOATING BUTTON
    function hideFloatingButton() {
        const btn = document.getElementById('floatingClearBtn');
        if (btn) btn.style.display = 'none';
    }

    // âœ… SETUP AUTO-SAVE ON INPUT CHANGES
    function setupAutoSave() {
        const formInputs = [
            'customerName', 'customerEmailInput', 'branchCity', 'customerAddress', 
            'customerLandmark', 'createdBy', 'discount', 'shipping', 
            'orderNotes', 'customerPhone', 'paymentMethod', 'taxPercent', 'inOutSelect'
        ];

        formInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('input', saveFormData);
                element.addEventListener('change', saveFormData);
            }
        });

        const orderFromSelect = document.querySelector('select[name="order_from"]');
        const orderStatusSelect = document.querySelector('select[name="order_status"]');
        
        if (orderFromSelect) {
            orderFromSelect.addEventListener('change', saveFormData);
        }
        if (orderStatusSelect) {
            orderStatusSelect.addEventListener('change', saveFormData);
        }
    }

    // âœ… SEARCH CUSTOMER BY PHONE
    function searchCustomerByPhone(phone) {
        const phoneInput = document.getElementById('phoneSearch');
        
        phoneInput.style.borderColor = '#f59e0b';
        phoneInput.style.background = '#fffbeb';
        
        fetch(`/api/search-customer-by-phone/?phone=${encodeURIComponent(phone)}`)
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (data.success && data.customer) {
                    document.getElementById('customerName').value = data.customer.name || '';
                    document.getElementById('customerEmailInput').value = data.customer.email || '';
                    document.getElementById('customerPhone').value = data.customer.phone || '';
                    document.getElementById('customerAddress').value = data.customer.address || '';
                    document.getElementById('customerLandmark').value = data.customer.landmark || '';
                    
                    if (data.customer.branch_city) {
                        document.getElementById('branchCity').value = data.customer.branch_city;
                        detectValleyStatusFromCity();
                    }
                    
                    phoneInput.style.borderColor = '#10b981';
                    phoneInput.style.background = '#d1fae5';
                    
                    showToastNotification(`âœ… Customer found: ${data.customer.name}`, 'success');
                    
                    saveFormData();
                    
                    setTimeout(() => {
                        phoneInput.style.borderColor = '';
                        phoneInput.style.background = '';
                    }, 2000);
                } else {
                    phoneInput.style.borderColor = '#ef4444';
                    phoneInput.style.background = '#fee2e2';
                    
                    showToastNotification(data.message || 'No customer found with this phone number', 'warning');
                    
                    setTimeout(() => {
                        phoneInput.style.borderColor = '';
                        phoneInput.style.background = '';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error searching customer:', error);
                phoneInput.style.borderColor = '#ef4444';
                phoneInput.style.background = '#fee2e2';
                showToastNotification('Error searching customer. Please try again.', 'error');
                
                setTimeout(() => {
                    phoneInput.style.borderColor = '';
                    phoneInput.style.background = '';
                }, 2000);
            });
    }

    // âœ¨ CUSTOM PRODUCT FUNCTIONALITY

    // Open custom product modal
    function openCustomProductModal() {
        // Clear form
        document.getElementById('customProductForm').reset();
        document.getElementById('customImagePreviewContainer').style.display = 'none';
        customProductImageFile = null;
        
        // Auto-generate SKU
        const timestamp = Date.now().toString().slice(-8);
        document.getElementById('customProductSKU').value = `CUSTOM-${timestamp}`;
        
        // Set default quantity
        document.getElementById('customProductQty').value = '1';
        
        // Show modal
        productModal.hide();
        setTimeout(() => {
            customProductModal.show();
        }, 300);
    }

    // Handle custom product image preview
    document.addEventListener('DOMContentLoaded', function() {
        const customImageInput = document.getElementById('customProductImage');
        if (customImageInput) {
            customImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    customProductImageFile = file;
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('customImagePreview').src = e.target.result;
                        document.getElementById('customImagePreviewContainer').style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
    });

    // Add custom product to cart
    function addCustomProductToCart() {
        const name = document.getElementById('customProductName').value.trim();
        const price = parseFloat(document.getElementById('customProductPrice').value);
        const qty = parseInt(document.getElementById('customProductQty').value);
        const sku = document.getElementById('customProductSKU').value;
        const category = document.getElementById('customProductCategory').value;
        const description = document.getElementById('customProductDescription').value.trim();

        if (!name) {
            alert('Please enter product name');
            return;
        }

        if (!price || price <= 0) {
            alert('Please enter valid price');
            return;
        }

        if (!qty || qty <= 0) {
            alert('Please enter valid quantity');
            return;
        }

        // Generate unique ID for custom product (negative to avoid conflicts)
        const customId = -Date.now();

        const customProduct = {
            id: customId,
            varId: null,
            name: name,
            sku: sku,
            price: price,
            qty: qty,
            isCustom: true,
            category: category,
            description: description
        };

        addToCart(customProduct);
        customProductModal.hide();
        showToastNotification(`âœ… Custom product "${name}" added to cart!`, 'success');
    }

    // âœ… INITIALIZE
    document.addEventListener('DOMContentLoaded', function() {
        productModal = new bootstrap.Modal(document.getElementById('productModal'));
        variationModal = new bootstrap.Modal(document.getElementById('variationModal'));
        partialPaymentModal = new bootstrap.Modal(document.getElementById('partialPaymentModal'));
        customProductModal = new bootstrap.Modal(document.getElementById('customProductModal'));

        // Load existing order items into cart
        {% for item in order_items %}
        cart.push({
            id: {{ item.product.id }},
            varId: {% if item.variation %}{{ item.variation.id }}{% else %}null{% endif %},
            name: "{{ item.product.name|escapejs }}",
            sku: "{% if item.variation %}{% if item.variation.variation_name %}{{ item.variation.variation_name|escapejs }}{% else %}{{ item.variation.sku|escapejs }}{% endif %}{% elif item.product.sku %}{{ item.product.sku|escapejs }}{% endif %}",
            price: {{ item.price }},
            qty: {{ item.quantity }},
            isCustom: {{ item.product.is_custom|yesno:'true,false' }},
            category: "{% if item.product.category %}{{ item.product.category.id }}{% endif %}",
            description: "{{ item.product.description|escapejs|default:'' }}"
        });
        {% endfor %}

        // Check for draft and auto-restore unless the user just cleared it
        const hasDraft = localStorage.getItem(STORAGE_KEY);
        console.log('ðŸ” Draft keys status:', { primary: !!hasDraft, backup: !!localStorage.getItem(STORAGE_KEY + '_backup'), cartLength: cart.length });
        if (hasDraft) {
            const draft = JSON.parse(hasDraft);
            const justCleared = sessionStorage.getItem('order_edit_just_cleared');

            if (justCleared) {
                // User cleared the draft in this tab â€” do not auto-restore and remove the flag
                try { sessionStorage.removeItem('order_edit_just_cleared'); } catch(e) {}
                updateCart();
                updateTotal();
            } else {
                // Auto-restore draft (no prompt) so changes persist across refreshes
                const restored = loadFormData();
                if (!restored) {
                    updateCart();
                    updateTotal();
                }
            }

            if (cart.length > 0) {
                showFloatingButton();
            }
        } else {
            updateCart();
            updateTotal();
        }

        // Setup auto-save
        setupAutoSave();
        setInterval(saveFormData, 5000);

        // Ensure latest state is saved when user quickly refreshes or navigates away
        window.addEventListener('beforeunload', function() { try { console.log('event: beforeunload - saving draft'); saveFormData(); } catch(e) {} });
        window.addEventListener('pagehide', function() { try { console.log('event: pagehide - saving draft'); saveFormData(); } catch(e) {} });
        document.addEventListener('visibilitychange', function() { if (document.hidden) try { console.log('event: visibilitychange (hidden) - saving draft'); saveFormData(); } catch(e) {} });

        // Listen for storage events (useful to detect changes done in other tabs/pages)
        window.addEventListener('storage', function(e) {
            try {
                console.warn('Storage event detected:', e.key, e.newValue ? 'set' : 'removed');
                if (e.key && (e.key.indexOf(STORAGE_KEY) === 0 || e.key.indexOf(SESSION_KEY) === 0)) {
                    console.warn('Draft-related storage change detected', e);
                }
            } catch (err) { console.error('Error handling storage event', err); }
        });

        // Detect valley status on city change
        document.getElementById('branchCity').addEventListener('change', detectValleyStatusFromCity);

        // Initial valley detection
        if (document.getElementById('branchCity').value) {
            detectValleyStatusFromCity();
        }

        // Phone search
        document.getElementById('phoneSearch').addEventListener('input', function(e) {
            const phone = e.target.value.trim();
            
            clearTimeout(phoneSearchTimer);
            
            if (!phone) {
                this.style.borderColor = '';
                this.style.background = '';
                return;
            }
            
            this.style.borderColor = '#3b82f6';
            this.style.background = '#eff6ff';
            
            phoneSearchTimer = setTimeout(() => {
                searchCustomerByPhone(phone);
            }, 500);
        });

        // Product modal
        document.getElementById('productModal').addEventListener('shown.bs.modal', () => {
            loadProducts('');
            document.getElementById('searchProduct').value = '';
            document.getElementById('searchProduct').focus();
        });

        // Product search
        document.getElementById('searchProduct').addEventListener('input', function(e) {
            loadProducts(e.target.value);
        });

        // Variation modal
        document.getElementById('variationModal').addEventListener('shown.bs.modal', function() {
            const firstItem = document.querySelector('.variation-item');
            if (firstItem) {
                setTimeout(() => firstItem.focus(), 100);
            }
        });

        document.getElementById('variationModal').addEventListener('hidden.bs.modal', function() {
            const trigger = document.getElementById('addProductsBtn');
            if (trigger) {
                setTimeout(() => trigger.focus(), 100);
            }
        });

        // Update total on discount/shipping/tax change
        document.getElementById('discount').addEventListener('input', updateTotal);
        document.getElementById('shipping').addEventListener('input', updateTotal);
        document.getElementById('taxPercent').addEventListener('input', updateTotal);

        // Form submission
        document.getElementById('orderForm').addEventListener('submit', function(e) {
            if (cart.length === 0) {
                e.preventDefault();
                alert('Please add at least one product to the order');
                return false;
            }

            // Clear draft on successful submission
            clearFormData();
            hideFloatingButton();
            
            return true;
        });

        // Show partial payment info if exists
        {% if order.is_partial_payment %}
        isPartialPaymentSelected = true;
        const paymentLabel = document.querySelector('select[name="payment_method"]').closest('.col-md-2');
        let infoBox = paymentLabel.querySelector('.payment-info-box');
        
        if (!infoBox) {
            infoBox = document.createElement('div');
            infoBox.className = 'payment-info-box';
            paymentLabel.appendChild(infoBox);
        }
        
        infoBox.innerHTML = `
            <small>
                <strong>Paid:</strong> à¤°à¥‚ {{ order.partial_amount_paid|floatformat:2 }}<br>
                <strong>Remaining:</strong> à¤°à¥‚ {{ order.remaining_amount|floatformat:2 }}
            </small>
        `;
        {% endif %}
    });
</script>
{% endblock %}
