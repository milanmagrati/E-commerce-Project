{% extends 'base.html' %}
{% block title %}{{ product.name }} - Admin Panel{% endblock %}

{% block content %}
<div class="row mb-4">
  <div class="col-12">
    <a href="{% url 'products' %}" class="btn btn-secondary mb-3">
      <i class="fas fa-arrow-left"></i> Back to Products
    </a>

    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
      <h2 class="mb-0">{{ product.name }}</h2>

      <div class="d-flex gap-2">
        {% if product.product_type == 'variable' %}
        <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#createVariationModal">
          <i class="fas fa-layer-group"></i> Add Variation
        </button>
        {% endif %}

        <a href="{% url 'product_edit' product.id %}" class="btn btn-warning">
          <i class="fas fa-edit"></i> Edit
        </a>

        <form method="POST" action="{% url 'product_move_to_trash' product.id %}" 
        onsubmit="return confirm('Move this product to trash?');" class="d-inline">
    {% csrf_token %}
    <button type="submit" class="btn btn-danger">
      <i class="fas fa-trash-alt"></i> Move to Trash
    </button>
  </form>
      </div>
    </div>
  </div>
</div>

<div class="row g-4">
  <!-- Left Column -->
  <div class="col-lg-4">

    <!-- Main Product Image -->
    <div class="card shadow-sm">
      <div class="card-header bg-gradient-primary text-white">
        <h5 class="mb-0"><i class="fas fa-image"></i> Product Image</h5>
      </div>
      <div class="card-body p-2">
        <div class="main-image-container position-relative">
          {% if product.image %}
          <img id="mainProductImage" src="{{ product.image.url }}" alt="{{ product.name }}"
               class="img-fluid rounded" style="width: 100%; height: 400px; object-fit: cover;">
          {% else %}
          <div id="mainProductImage" class="no-image-placeholder rounded">
            <i class="fas fa-image fa-5x text-muted"></i>
            <p class="text-muted mt-3">No image uploaded</p>
          </div>
          {% endif %}

          <div class="zoom-overlay" onclick="openImageModal()">
            <i class="fas fa-search-plus fa-2x"></i>
          </div>
        </div>

        <div class="mt-3 text-center">
          {% if product.is_active %}
          <span class="badge bg-success fs-6 me-2"><i class="fas fa-check-circle"></i> Active</span>
          {% else %}
          <span class="badge bg-secondary fs-6 me-2"><i class="fas fa-times-circle"></i> Inactive</span>
          {% endif %}

          <span class="badge bg-{% if product.stock > 10 %}success{% elif product.stock > 0 %}warning{% else %}danger{% endif %} fs-6 me-2">
            <i class="fas fa-boxes"></i> Stock: {{ product.stock }}
          </span>

          <span class="badge bg-{% if product.stock_status == 'in_stock' %}success{% elif product.stock_status == 'low_stock' %}warning{% else %}danger{% endif %} fs-6">
            {{ product.get_stock_status_display }}
          </span>
        </div>

        <div class="mt-2 text-center">
          {% if product.product_type == 'variable' %}
          <span class="badge bg-primary fs-6"><i class="fas fa-layer-group"></i> Variable Product</span>
          {% else %}
          <span class="badge bg-info fs-6"><i class="fas fa-cube"></i> Simple Product</span>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Product Gallery -->
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-images"></i> Product Gallery</h6>

        <button type="button" class="btn btn-sm btn-light"
                onclick="document.getElementById('galleryUploadInput').click();">
          <i class="fas fa-plus"></i> Add More
        </button>
      </div>

      <div class="card-body p-2">
        <form id="galleryUploadForm" method="POST" enctype="multipart/form-data"
              action="{% url 'product_gallery_upload' product.id %}" class="d-none">
          {% csrf_token %}
          <input id="galleryUploadInput" type="file" name="images" accept="image/*" multiple>
        </form>

        {% if product.image or product.images.exists %}
        <div class="gallery-grid">
          {% if product.image %}
          <div class="gallery-item active" onclick="changeMainImage('{{ product.image.url }}', 'Main Product Image', this)">
            <img src="{{ product.image.url }}" class="img-fluid" alt="Main Product">
            <div class="gallery-badge"><span class="badge bg-primary">Main</span></div>
          </div>
          {% endif %}

          {% for img in product.images.all %}
          <div class="gallery-item" onclick="changeMainImage('{{ img.image.url }}', '{{ img.alt_text|default:"Gallery Image" }}', this)">
            <img src="{{ img.image.url }}" class="img-fluid" alt="{{ img.alt_text|default:'Product Image' }}">

            {% if img.is_featured %}
            <div class="gallery-badge">
              <span class="badge bg-warning"><i class="fas fa-star"></i> Featured</span>
            </div>
            {% endif %}

            <div class="gallery-actions">
              <form method="POST" action="{% url 'delete_product_image' img.id %}"
                  onsubmit="event.stopPropagation(); return confirm('Delete this image?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                  <i class="fas fa-trash"></i>
                </button>
              </form>
            </div>
          </div>
          {% endfor %}
        </div>

        <div class="text-center mt-2 p-2 bg-light rounded">
          <small class="text-muted fw-bold">
            <i class="fas fa-images text-primary"></i>
            Total:
            <span class="text-primary">
              {% if product.image %}{{ product.images.count|add:1 }}{% else %}{{ product.images.count }}{% endif %}
            </span>
            image{% if product.images.count != 0 or product.image %}s{% endif %} in gallery
          </small>
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-images fa-4x text-muted mb-3 d-block"></i>
          <p class="text-muted mb-0">No gallery images yet</p>
        </div>
        {% endif %}
      </div>
    </div>

    <!-- Quick Stats -->
    <div class="card shadow-sm mt-3">
      <div class="card-header bg-gradient-primary text-white">
        <h5 class="mb-0"><i class="fas fa-chart-line"></i> Quick Stats</h5>
      </div>
      <div class="card-body">
        <div class="stat-row">
          <span class="text-muted">Created:</span>
          <strong>{{ product.created_at|date:"M d, Y" }}</strong>
        </div>
        <div class="stat-row">
          <span class="text-muted">Last Updated:</span>
          <strong>{{ product.updated_at|date:"M d, Y" }}</strong>
        </div>
        <div class="stat-row">
          <span class="text-muted">Created By:</span>
          <strong>{{ product.user.username }}</strong>
        </div>
        <div class="stat-row border-0">
          <span class="text-muted">Product ID:</span>
          <strong>#{{ product.id }}</strong>
        </div>
      </div>
    </div>

  </div>

  <!-- Right Column -->
  <div class="col-lg-8">

    <!-- Basic Information -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Basic Information</h5>
      </div>
      <div class="card-body">
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="text-muted small">Product Name</label>
            <h5 class="mb-0">{{ product.name }}</h5>
          </div>
          <div class="col-md-6">
            <label class="text-muted small">Slug (URL)</label>
            <p class="mb-0">
              <code>{{ product.slug }}</code>
              <button class="btn btn-sm btn-outline-secondary ms-2" onclick="copyToClipboard('{{ product.slug }}')">
                <i class="fas fa-copy"></i>
              </button>
            </p>
          </div>
        </div>

        <div class="mb-3">
          <label class="text-muted small">Description</label>
          <p class="mb-0" style="white-space: pre-wrap;">{{ product.description }}</p>
        </div>

        <div class="row">
          <div class="col-md-6">
            <label class="text-muted small">Category</label>
            <p class="mb-0">
              {% if product.category %}
              <span class="badge bg-primary"><i class="fas fa-folder"></i> {{ product.category.name }}</span>
              {% else %}
              <span class="text-muted">Uncategorized</span>
              {% endif %}
            </p>
          </div>
          <div class="col-md-6">
            <label class="text-muted small">Product Type</label>
            <p class="mb-0">
              {% if product.product_type == 'variable' %}
              <span class="badge bg-primary"><i class="fas fa-layer-group"></i> Variable Product</span>
              {% else %}
              <span class="badge bg-info"><i class="fas fa-cube"></i> Simple Product</span>
              {% endif %}
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- Pricing & Inventory -->
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-dollar-sign"></i> Pricing & Inventory</h5>
      </div>
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-3">
            <div class="text-center p-3 bg-success bg-opacity-10 rounded">
              <small class="text-muted d-block mb-1">Selling Price</small>
              <h4 class="text-success mb-0">रू {{ product.price|floatformat:2 }}</h4>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center p-3 bg-danger bg-opacity-10 rounded">
              <small class="text-muted d-block mb-1">Cost Price</small>
              <h4 class="text-danger mb-0">रू {{ product.cost_price|floatformat:2 }}</h4>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center p-3 bg-primary bg-opacity-10 rounded">
              <small class="text-muted d-block mb-1">Profit</small>
              <h4 class="text-primary mb-0">रू {{ profit|floatformat:2 }}</h4>
            </div>
          </div>
          <div class="col-md-3">
            <div class="text-center p-3 bg-info bg-opacity-10 rounded">
              <small class="text-muted d-block mb-1">Stock Quantity</small>
              <h4 class="text-info mb-0">{{ product.stock }}</h4>
            </div>
          </div>
        </div>

        <div class="row mt-3">
          <div class="col-md-6">
            <div class="p-3 border rounded">
              <label class="text-muted small">Stock Status</label>
              <p class="mb-0">
                <span class="badge bg-{% if product.stock_status == 'in_stock' %}success{% elif product.stock_status == 'low_stock' %}warning{% else %}danger{% endif %} fs-6">
                  {{ product.get_stock_status_display }}
                </span>
              </p>
            </div>
          </div>
          <div class="col-md-6">
            <div class="p-3 border rounded">
              <label class="text-muted small">Visibility</label>
              <p class="mb-0">
                {% if product.is_active %}
                <span class="badge bg-success fs-6"><i class="fas fa-eye"></i> Visible to Customers</span>
                {% else %}
                <span class="badge bg-secondary fs-6"><i class="fas fa-eye-slash"></i> Hidden from Customers</span>
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Product Variations -->
    {% if product.product_type == 'variable' %}
    <div class="card mb-3 shadow-sm">
      <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="fas fa-layer-group"></i> Product Variations</h5>
        <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#createVariationModal">
          <i class="fas fa-plus"></i> Add Variation
        </button>
      </div>

      <div class="card-body">
        {% if product.variations.exists %}
        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>IMAGE</th>
                <th>VARIANT</th>
                <th>SKU</th>
                <th>PRICE</th>
                <th>STOCK</th>
                <th>STATUS</th>
                <th style="width:140px;">ACTIONS</th>
              </tr>
            </thead>
            <tbody>
              {% for variation in product.variations.all %}
              <tr>
                <td>
                  {% if variation.image %}
                  <img src="{{ variation.image.url }}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;" alt="Variation">
                  {% else %}
                  <div style="width:50px;height:50px;background:#f0f0f0;border-radius:5px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-image text-muted"></i>
                  </div>
                  {% endif %}
                </td>
                <td>
                  {% if variation.variation_name %}
                  <strong class="text-primary">{{ variation.variation_name }}</strong>
                  {% else %}
                  <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td><code>{{ variation.sku }}</code></td>
                <td><strong class="text-success">रू {{ variation.price|floatformat:2 }}</strong></td>
                <td><span class="badge bg-info">{{ variation.stock }}</span></td>
                <td>
                  <span class="badge bg-{% if variation.status == 'active' %}success{% elif variation.status == 'inactive' %}secondary{% else %}danger{% endif %}">
                    {{ variation.status|title }}
                  </span>
                </td>
                <td class="d-flex gap-2">
                  <button type="button" class="btn btn-sm btn-warning"
                          data-bs-toggle="modal" data-bs-target="#editVariationModal{{ variation.id }}">
                    <i class="fas fa-pen"></i>
                  </button>

                  <form method="POST" action="{% url 'variation_delete' variation.id %}"
                        onsubmit="return confirm('Delete variation {{ variation.sku }}?');">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">
                      <i class="fas fa-trash"></i>
                    </button>
                  </form>
                </td>
              </tr>

              <!-- Edit Variation Modal -->
              <div class="modal fade" id="editVariationModal{{ variation.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title">Edit Variation: {{ variation.variation_name|default:variation.sku }}</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <form method="POST" enctype="multipart/form-data" action="{% url 'variation_update' variation.id %}">
                      {% csrf_token %}
                      <div class="modal-body">
                        <div class="row g-3">
                          <div class="col-md-6">
                            <label class="form-label fw-bold">
                              <i class="fas fa-tag text-info"></i> Variation Name *
                            </label>
                            <input type="text" name="variation_name" class="form-control" value="{{ variation.variation_name|default:'' }}" placeholder="e.g., Red, Medium" required>
                            <small class="text-muted">Human-readable variant name</small>
                          </div>
                          <div class="col-md-6">
                            <label class="form-label fw-bold">
                              <i class="fas fa-barcode text-warning"></i> SKU *
                            </label>
                            <input type="text" name="sku" class="form-control" value="{{ variation.sku }}" required>
                            <small class="text-muted">Unique inventory code</small>
                          </div>
                        </div>

                        <div class="row g-3 mt-2">
                          <div class="col-md-4">
                            <label class="form-label">Price (रू) *</label>
                            <input type="number" step="0.01" name="price" class="form-control" value="{{ variation.price }}" required>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Stock *</label>
                            <input type="number" name="stock" class="form-control" value="{{ variation.stock }}" min="0" required>
                          </div>
                          <div class="col-md-4">
                            <label class="form-label">Status *</label>
                            <select name="status" class="form-select" required>
                              <option value="active" {% if variation.status == 'active' %}selected{% endif %}>Active</option>
                              <option value="inactive" {% if variation.status == 'inactive' %}selected{% endif %}>Inactive</option>
                              <option value="out_of_stock" {% if variation.status == 'out_of_stock' %}selected{% endif %}>Out of Stock</option>
                            </select>
                          </div>
                        </div>

                        <div class="row g-3 mt-2">
                          <div class="col-md-12">
                            <label class="form-label">Replace Image (optional)</label>
                            <input type="file" name="image" class="form-control" accept="image/*">
                            {% if variation.image %}
                            <div class="mt-2">
                              <img src="{{ variation.image.url }}" style="max-width: 100px; border-radius: 5px;" alt="Current">
                              <small class="text-muted d-block">Current image</small>
                            </div>
                            {% endif %}
                          </div>
                        </div>
                      </div>

                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                          <i class="fas fa-save"></i> Save Changes
                        </button>
                      </div>
                    </form>

                  </div>
                </div>
              </div>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="alert alert-info mt-3 mb-0">
          <i class="fas fa-info-circle"></i>
          Total <strong>{{ product.variations.count }}</strong> variation{% if product.variations.count != 1 %}s{% endif %} available
        </div>
        {% else %}
        <div class="text-center py-4">
          <i class="fas fa-layer-group fa-3x text-muted mb-3 d-block"></i>
          <p class="text-muted mb-0">No variations created yet</p>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Recent Orders -->
    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-shopping-cart"></i> Recent Orders</h5>
      </div>
      <div class="card-body">
        {% if recent_items %}
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Order #</th>
                <th>Customer</th>
                <th>Quantity</th>
                <th>Price</th>
                <th>Total</th>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {% for item in recent_items %}
              <tr>
                <td>
                  <a href="{% url 'order_detail' item.order.id %}" class="text-decoration-none">
                    <strong>{{ item.order.order_number }}</strong>
                  </a>
                </td>
                <td>{{ item.order.customer_name }}</td>
                <td><span class="badge bg-info">{{ item.quantity }}</span></td>
                <td>रू {{ item.price|floatformat:2 }}</td>
                <td><strong class="text-success">रू {{ item.total|floatformat:2 }}</strong></td>
                <td><small>{{ item.order.created_at|date:"M d, Y" }}</small></td>
                <td>
                  <span class="badge bg-{% if item.order.order_status == 'delivered' %}success{% elif item.order.order_status == 'processing' %}primary{% elif item.order.order_status == 'shipped' %}info{% else %}warning{% endif %}">
                    {{ item.order.order_status|title }}
                  </span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="text-center py-5">
          <i class="fas fa-shopping-cart fa-4x text-muted mb-3 d-block"></i>
          <p class="text-muted mb-0">No orders for this product yet</p>
        </div>
        {% endif %}
      </div>
    </div>

  </div>
</div>

<!-- Image Zoom Modal -->
<div class="modal fade" id="imageZoomModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageZoomTitle">Product Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-0">
        <img id="zoomedImage" src="" class="img-fluid" style="max-height: 80vh;" alt="Zoomed Product">
      </div>
    </div>
  </div>
</div>

<!-- Create Variation Modal -->
{% if product.product_type == 'variable' %}
<div class="modal fade" id="createVariationModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-pink text-white">
        <h5 class="modal-title"><i class="fas fa-plus"></i> Create New Variation</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="POST" enctype="multipart/form-data"
            action="{% url 'variation_create' product.id %}" id="createVariationForm">
        {% csrf_token %}
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="fas fa-tag text-info"></i> Variation Name *
              </label>
              <input type="text" class="form-control" name="variation_name" placeholder="e.g., Red, Medium" required>
              <small class="text-muted">Human-readable variant name</small>
            </div>
            <div class="col-md-6">
              <label class="form-label fw-bold">
                <i class="fas fa-barcode text-warning"></i> SKU *
              </label>
              <input type="text" class="form-control" name="sku" placeholder="VAR-XXX-001" required>
              <small class="text-muted">Unique inventory code</small>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-4">
              <label class="form-label">Price (रू) *</label>
              <input type="number" step="0.01" class="form-control" name="price" value="{{ product.price }}" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Stock *</label>
              <input type="number" class="form-control" name="stock" value="0" min="0" required>
            </div>
            <div class="col-md-4">
              <label class="form-label">Status *</label>
              <select class="form-select" name="status" required>
                <option value="active" selected>Active</option>
                <option value="inactive">Inactive</option>
                <option value="out_of_stock">Out of Stock</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mt-2">
            <div class="col-md-12">
              <label class="form-label">Variation Image</label>
              <input type="file" class="form-control" name="image" accept="image/*">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save"></i> Create Variation
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<style>
  .bg-gradient-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
  .bg-pink { background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%); }

  .main-image-container { position: relative; overflow: hidden; border-radius: 10px; }
  .no-image-placeholder {
    height: 400px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }
  .zoom-overlay {
    position: absolute; inset: 0;
    background: rgba(0,0,0,.5);
    display: flex; align-items: center; justify-content: center;
    opacity: 0; transition: opacity .2s ease;
    cursor: pointer; color: #fff;
  }
  .main-image-container:hover .zoom-overlay { opacity: 1; }

  .gallery-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
  .gallery-item {
    position: relative; aspect-ratio: 1;
    overflow: hidden; border-radius: 8px;
    border: 3px solid #e0e0e0; cursor: pointer;
    transition: all .2s ease;
  }
  .gallery-item.active { border-color: #667eea; }
  .gallery-item img { width: 100%; height: 100%; object-fit: cover; }
  .gallery-badge { position: absolute; top: 6px; left: 6px; z-index: 2; }
  .gallery-actions {
    position: absolute; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,.85);
    padding: 8px; display: flex; justify-content: center;
    opacity: 0; transition: opacity .2s ease;
  }
  .gallery-item:hover .gallery-actions { opacity: 1; }

  .stat-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #e9ecef; }
  .stat-row:last-child { border-bottom: none; }
</style>

<script>
(function () {
  'use strict';

  // Auto-submit gallery upload
  const galleryInput = document.getElementById('galleryUploadInput');
  const galleryForm = document.getElementById('galleryUploadForm');
  if (galleryInput && galleryForm) {
    galleryInput.addEventListener('change', function () {
      if (galleryInput.files && galleryInput.files.length > 0) galleryForm.submit();
    });
  }

  window.changeMainImage = function (imageUrl, altText, el) {
    const main = document.getElementById('mainProductImage');
    if (main && main.tagName === 'IMG') {
      main.src = imageUrl;
      main.alt = altText || 'Product Image';
    }

    document.querySelectorAll('.gallery-item').forEach(i => i.classList.remove('active'));
    if (el) el.classList.add('active');
  };

  window.openImageModal = function () {
    const main = document.getElementById('mainProductImage');
    if (!main || main.tagName !== 'IMG') return;

    const modalEl = document.getElementById('imageZoomModal');
    if (!modalEl || typeof bootstrap === 'undefined') return;

    document.getElementById('zoomedImage').src = main.src;
    document.getElementById('imageZoomTitle').textContent = main.alt || 'Product Image';
    new bootstrap.Modal(modalEl).show();
  };

  window.copyToClipboard = function (text) {
    if (navigator.clipboard && navigator.clipboard.writeText) {
      navigator.clipboard.writeText(text).then(() => alert('Copied: ' + text));
      return;
    }
    const temp = document.createElement('input');
    temp.value = text;
    temp.style.position = 'absolute';
    temp.style.left = '-9999px';
    document.body.appendChild(temp);
    temp.select();
    document.execCommand('copy');
    document.body.removeChild(temp);
    alert('Copied: ' + text);
  };

  // Reset create-variation form when closed
  const createModal = document.getElementById('createVariationModal');
  if (createModal) {
    createModal.addEventListener('hidden.bs.modal', function () {
      const f = document.getElementById('createVariationForm');
      if (f) f.reset();
    });
  }
})();
</script>
{% endblock %}
